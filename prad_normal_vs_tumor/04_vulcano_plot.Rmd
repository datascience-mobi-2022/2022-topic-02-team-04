---
title: "Vulcano plot new"
author: "Laura Lange"
date: '2022-05-25'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Load data

```{r}
tcga_tumor_norm = readRDS("data/tcga_tumor_normal_datascience_proj_2022.RDS")
```

```{r}
# get list PRAD data
PRAD <- tcga_tumor_norm[["PRAD"]]

# Fuse data frame PRAD normal with PRAD tumor
PRAD_normal_tumor <- cbind(PRAD[[1]], PRAD[[2]])
```

Clean data 

```{r}
# Check for NA
PRAD_na <- apply(PRAD_normal_tumor, 1, function(x) any(is.na(x)))
rownames(PRAD_na)

# Get rid of genes that are not expressed (Variance < 1)
SD <- apply(PRAD_normal_tumor, 1, sd)
Vari <- SD^2

PRAD_Var <- which(Vari < 1)
PRAD_cleaned <- PRAD_normal_tumor[Vari > 1, ]

# control
Cleaned <- apply(PRAD_cleaned, 1, var)
min(Cleaned)

dim(PRAD_cleaned)

```
Transform data

```{r}
class(PRAD_cleaned)

# transform data frame into matrix 
PRAD_matrix <- as.matrix(PRAD_cleaned)

```
Calculate mean for each gene 

```{r}
mean_normal <- apply(PRAD_matrix[ ,1:52], 1, mean)

mean_tumor <- apply(PRAD_matrix[ ,53:104], 1, mean)
```

Calculate Fold Change 

$$
log_2[(T)/N]
$$

T = tumor 
N = normal 

```{r}
e_mean_tumor <- 2^mean_tumor
e_mean_normal <- 2^mean_normal
FoldChange <- e_mean_tumor / e_mean_normal

log2FoldChange <- log2(FoldChange)
```

Calculate significane of the fold change (paired wilcox-test)

```{r}
# calculate p-value with apply function 

p_value_1 <- apply(PRAD_matrix, 1, function(x) wilcox.test(x[1:52], 
                                                         x[53:104], 
                                                         paired = TRUE,
                                                         exact = FALSE)$p.value)

# we will continue working with this p-values
```


```{r}
# calculate p-value with for loop; stored in data frame

p_value_2 <- data.frame(NA_col = rep(NA, 8159))

for(index in 1:nrow(PRAD_matrix)) {
  p_value_2[index, ] <- wilcox.test(PRAD_matrix[index,1:52], 
                                    PRAD_matrix[index,53:104],
                                    paired = TRUE,
                                    exact = FALSE)$p.value
  }

colnames(p_value_2) <- c("p-value")
```


```{r}
# calculate p-value with for loop; stored in matrix

p_value_3 <- matrix(nrow = 8159, ncol = 116)

for(index in 1:nrow(PRAD_matrix)) {
  p_value_3[index, ] <- wilcox.test(PRAD_matrix[index,1:52], 
                                    PRAD_matrix[index,53:104],
                                    paired = TRUE,
                                    exact = FALSE)$p.value
  }
```

Plot not corrected p-values 

```{r}
# not correced p-values 

hist(p_value_1, breaks = 20)
```

correct p-values and plot them again 

```{r}
# correct p-value via Bonferroni ("bonferroni") / Benjamini-Hichberg ("BH")

corrected_p_value <- p.adjust(p_value_1, method = "bonferroni")

# plot correced p-values 

hist(corrected_p_value, breaks = 20)
```
Create vulcano plot with not correced p-values 

```{r}
log2_FoldChange <- log2FoldChange
p_value <- p_value_1
dat <- data.frame(log2_FoldChange, p_value)

# add a column of NAs
dat$diffexpressed <- "NO"
# if log2Foldchange > 0.6 and pvalue < 0.05, set as "UP" 
dat$diffexpressed[dat$log2_FoldChange > 0.6 & dat$p_value < 0.05] <- "UP"
# if log2Foldchange < -0.6 and pvalue < 0.05, set as "DOWN"
dat$diffexpressed[dat$log2_FoldChange < -0.6 & dat$p_value < 0.05] <- "DOWN"

# Change point color
color <- c("blue", "red", "black")
names(color) <- c("DOWN", "UP", "NO")

library(ggplot2)

ggplot(data = dat, mapping = aes(x=log2_FoldChange, y= -log10(p_value), col = diffexpressed))+
  geom_point() +
  theme_minimal() +
  scale_color_manual(values = color) +
  geom_vline(xintercept=c(-0.6, 0.6), col="red") +
  geom_hline(yintercept=-log10(0.05), col="red") +
  labs(title = "Vulcano plot")
```

Create vulcano plot with corrected p-values 

```{r}
log2_FoldChange <- log2FoldChange
p_value_corrected <- corrected_p_value
dat <- data.frame(log2_FoldChange, p_value_corrected)

# add a column of NAs
dat$diffexpressed <- "NO"
# if log2Foldchange > 0.6 and pvalue < 0.05, set as "UP" 
dat$diffexpressed[dat$log2_FoldChange > 0.6 & dat$p_value_corrected < 0.05] <- "UP"
# if log2Foldchange < -0.6 and pvalue < 0.05, set as "DOWN"
dat$diffexpressed[dat$log2_FoldChange < -0.6 & dat$p_value_corrected < 0.05] <- "DOWN"

# Change point color
color <- c("blue", "red", "black")
names(color) <- c("DOWN", "UP", "NO")

library(ggplot2)

ggplot(data = dat, mapping = aes(x=log2_FoldChange, y= -log10(p_value_corrected), 
                                 col = diffexpressed))+
  geom_point() +
  theme_minimal() +
  scale_color_manual(values = color) +
  geom_vline(xintercept=c(-0.6, 0.6), col="red") +
  geom_hline(yintercept=-log10(0.05), col="red") +
  labs(title = "Vulcano plot")
```

Create vulcano plot with genes of one pathway 

```{r}
log2_FoldChange <- log2FoldChange
p_value_corrected <- corrected_p_value
dat <- data.frame(log2_FoldChange, p_value_corrected)

# add a column of NAs
dat$diffexpressed <- "NO"
# if log2Foldchange > 0.6 and pvalue < 0.05, set as "UP" 
dat$diffexpressed[dat$log2_FoldChange > 0.6 & dat$p_value_corrected < 0.05] <- "UP"
# if log2Foldchange < -0.6 and pvalue < 0.05, set as "DOWN"
dat$diffexpressed[dat$log2_FoldChange < -0.6 & dat$p_value_corrected < 0.05] <- "DOWN"


# load gene set
library(msigdbr)
h_gene_sets <- msigdbr(species = "Homo sapiens", category = "H")
h_spermatogenesis <- h_gene_sets[h_gene_sets$gs_name == "HALLMARK_SPERMATOGENESIS",]
# list of genes in pathway
h_spermatogenesis_genes <- as.list(h_spermatogenesis["ensembl_gene"])
class(h_spermatogenesis_genes)
# list of all genes 
all_genes <- as.list(rownames(PRAD_matrix))
class(all_genes)
# matching genes 
matching_genes <- lapply(all_genes, function(x) all(h_spermatogenesis_genes %in% x))
class(matching_genes)

# add a column of NAs
dat$pathway_genes <- matching_genes

# cbind(dat, matching_genes)

# Change point color
color <- c("blue", "red", "black")
names(color) <- c("DOWN", "UP", "NO")

library(ggplot2)

ggplot(data = dat, mapping = aes(x=log2_FoldChange, y= -log10(p_value_corrected)))+
  geom_point(aes (col = diffexpressed)) +
  geom_point(aes (shape = factor(pathway_genes))) +
  theme_minimal() +
  scale_shape_manual(values = 5) +
  scale_color_manual(values = color) +
  geom_vline(xintercept=c(-0.6, 0.6), col="red") +
  geom_hline(yintercept=-log10(0.05), col="red") +
  labs(title = "Vulcano plot")
```

