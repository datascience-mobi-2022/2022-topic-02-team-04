---
title: "05_biotype_analysis"
author: "Fabian Strobel"
date: '2022-05-15'
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

-----------------------------------------
## TCGA Matrix ##
-----------------------------------------

```{r genes from expression matrix}
setwd('../')

tcga_exp_cleaned <- readRDS("data/tcga_exp_variance_filtered.rds")
genes <- rownames(tcga_exp_cleaned)
#saveRDS(genes, file = "tcga_exp_variance_filtered_genes.rds")

genes <- readRDS("data/tcga_exp_variance_filtered_genes.rds")
```

```{r Split ENSG identifier from Gene Symbol}
gene_identifier <- strsplit(genes, split = "|", fixed = TRUE)

genes_ens<- sapply(gene_identifier, FUN = function(gene_identifier){
  ens = gene_identifier[1]
  return(ens)
})

genes_symbol<- sapply(gene_identifier, FUN = function(gene_identifier){
  ens = gene_identifier[2]
  return(ens)
})
```

```{r Remove version number}
genes_ens_vn <- strsplit(genes_ens, split = ".", fixed = TRUE)
genes_ensembl <- sapply(genes_ens_vn, FUN = function(genes_ens_vn){
  ens = genes_ens_vn[1]
  return(ens)
})
```

```{r}
rm(gene_identifier)
rm(genes_ens_vn)
rm(genes_ens)
rm(genes_symbol)
```

```{r library}
library(biomaRt)
```

```{r Biotypes of genes}
#mart = useEnsembl(dataset = "hsapiens_gene_ensembl", biomart='ensembl')

#list_biotype = getBM(attributes = c("ensembl_gene_id", "gene_biotype"), filters = "ensembl_gene_id", values = genes_ensembl, mart = mart, useCache = FALSE)
```
38268 matches -> not used

```{r}
list_biotype <- ensembldb::select(EnsDb.Hsapiens.v79, keys= genes_ensembl, keytype = "GENEID", columns = c("GENEBIOTYPE"))
```
From 39324 input genes, 39226 could be matched with a corresponding biotype. But what about the rest?

```{r}
list_biotype_genes <- list_biotype[,1]

unmatched_genes <- setdiff(genes_ensembl, list_biotype_genes)
```

```{r investigate unmatched data}
unmatched_genes_exp <- tcga_exp_cleaned[unmatched_genes,]

## Compute mean of every row/ for every gene
means_umatched_genes = apply(unmatched_genes_exp,1,mean)
variance_unmatched_genes = apply(unmatched_genes_exp,1,var)

plot(means_umatched_genes,variance_unmatched_genes, main = "Mean-variance plot for genes \n without known biotype")

mv <- data.frame(means_umatched_genes, variance_unmatched_genes)

library(ggplot2)

ggplot(mv, aes(x = means_umatched_genes, y = variance_unmatched_genes)) +
  geom_point() + ggtitle("Mean-variance plot for genes without known biotype")
```

```{r}
biotypes <- unique(list_biotype[2])
biotypes

biotypes_counts <- data.frame(matrix(NA, nrow = 37))
rownames(biotypes_counts) = biotypes[,1]
colnames(biotypes_counts) = "counts"

for (i in 1:nrow(biotypes)){
  biotypes_counts[i,] <- length(which(list_biotype$GENEBIOTYPE == biotypes[i,]))
}

biotypes_counts

TCGA_biotypes <- biotypes_counts
```



-----------------------------------------
## Gene sets ##
-----------------------------------------
```{r load gene sets}
setwd('../')
pathways <- readRDS("total_pathways_ensID.rds")

p_genes <- c(pathways$Angio_AACR,
             pathways$Angio_ALL, 
             pathways$Angio_VEGF, 
             pathways$Angio_N_Reg, 
             pathways$Angio_P_Reg, 
             pathways$Apop_AACR, 
             pathways$Apop_ALL, 
             pathways$Apop_SURVIVAL, 
             pathways$Genome_AACR, 
             pathways$Genome_DN_Reg, 
             pathways$Genome_REPAIR, 
             pathways$Growth_AACR, 
             pathways$Growth_ALL, 
             pathways$Growth_CONTACT_Inh, 
             pathways$Growth_Tumor_Supp, 
             pathways$Immune_AACR, 
             pathways$Immune_ALL, 
             pathways$Immune_UP,
             pathways$Immune_DN, 
             pathways$Immune_Ils,
             pathways$Inflam_AACR, 
             pathways$Inflam_PRO, 
             pathways$Inflam_NEG, 
             pathways$Meta_AACR, 
             pathways$Meta_Glc,
             pathways$Meta_Gln, 
             pathways$Meta_Chol, 
             pathways$Meta_FA, 
             pathways$Meta_HIF1,
             pathways$Metas_AACR,
             pathways$Metas_ALL, 
             pathways$Metas_EMT_MMP, 
             pathways$Metas_NEG, 
             pathways$Metas_EMT, 
             pathways$Prol_AACR, 
             pathways$Prol_EGFR, 
             pathways$Prol_MAPK, 
             pathways$Prol_PI3CK, 
             pathways$Prol_NOTCH, 
             pathways$Prol_ERK, 
             pathways$Prol_RAS, 
             pathways$Prol_JAK_STAT, 
             pathways$Prol_MTOR, 
             pathways$Prol_WNT, 
             pathways$Replication_AACR, 
             pathways$Replication_Telomerase, 
             pathways$angiogenesis, 
             pathways$apical_junction, 
             pathways$apical_surface, 
             pathways$apoptosis, 
             pathways$bile_acid_metabolism, 
             pathways$cholesterol_homeostasis, 
             pathways$complement, 
             pathways$dna_repair, 
             pathways$epithelial_mesenchymal_transition, 
             pathways$fatty_acid_metabolism, 
             pathways$g2m_checkpoint, 
             pathways$glycolysis, 
             pathways$hypoxia, 
             pathways$inflammatory_response, 
             pathways$oxidative_phosphorylation, 
             pathways$peroxisome, 
             pathways$reactive_oxygen_species, 
             pathways$spermatogenesis, 
             pathways$xenobiotic_metabolism)

lengths(pathways)
sum(lengths(pathways))
length(p_genes)

dupl <- duplicated(p_genes)
table(dupl)
p_genes <- p_genes[dupl == "FALSE"]

length(p_genes)
rm(dupl)
```

```{r library}
library(biomaRt)
library(EnsDb.Hsapiens.v79)
```

```{r Biotypes of genes biomart}
mart = useEnsembl(dataset = "hsapiens_gene_ensembl", biomart='ensembl')

p_list_biotype = getBM(attributes = c("ensembl_gene_id", "gene_biotype"), filters = "ensembl_gene_id", values = p_genes, mart = mart, useCache = FALSE)
```
From 8,239 input genes, 7,797 could be matched with a corresponding biotype. But what about the rest?

```{r EnsDb.Hsapiens.v79}
p_list_biotypes_EnsDb <- ensembldb::select(EnsDb.Hsapiens.v79, keys= p_genes, keytype = "GENEID", columns = c("GENEBIOTYPE"))
```
From 8,239 input genes, 8,194 could be matched with a corresponding biotype.

But what about the rest?
```{r}
p_list_biotypes_EnsDb_genes <- p_list_biotypes_EnsDb[,1]

p_unmatched_genes <- setdiff(p_genes, p_list_biotypes_EnsDb_genes)
length(p_unmatched_genes)
```


```{r}
p_biotypes <- unique(p_list_biotype[2])
p_biotypes

p_biotypes_counts <- data.frame(matrix(NA, nrow = nrow(p_biotypes)))
rownames(p_biotypes_counts) = p_biotypes[,1]
colnames(p_biotypes_counts) = "counts"

for (i in 1:nrow(p_biotypes)){
  p_biotypes_counts[i,] <- length(which(p_list_biotypes_EnsDb$GENEBIOTYPE == p_biotypes[i,]))
}

p_biotypes_counts

pathways_biotypes <- p_biotypes_counts
```


What we can see is that the protein coding genes make up the majority of our pathway genes

Let's extract the protein coding genes of our pathways and store them in *protein_coding*

```{r}
protein_coding = p_list_biotype[which(p_list_biotypes_EnsDb$GENEBIOTYPE == "protein_coding"), 1]
```

In order to check back on the non coding genes, storing them in an individual variable and combining these variables in *non_coding_pathway_genes* might be helpful

```{r}
miRNA = p_list_biotype[which(p_list_biotypes_EnsDb$GENEBIOTYPE == "miRNA"), 1]
length(miRNA)

polymorphic_pseudogene = p_list_biotype[which(p_list_biotypes_EnsDb$GENEBIOTYPE == "polymorphic_pseudogene"), 1]
length(polymorphic_pseudogene)

Mt_rRNA = p_list_biotype[which(p_list_biotypes_EnsDb$GENEBIOTYPE == "Mt_rRNA"), 1]
length(Mt_rRNA)

lncRNA = p_list_biotype[which(p_list_biotypes_EnsDb$GENEBIOTYPE == "lncRNA"), 1]
length(lncRNA)

processed_pseudogene = p_list_biotype[which(p_list_biotypes_EnsDb$GENEBIOTYPE == "processed_pseudogene"), 1]
length(miRNA)

unprocessed_pseudogene = p_list_biotype[which(p_list_biotypes_EnsDb$GENEBIOTYPE == "unprocessed_pseudogene"), 1]
length(unprocessed_pseudogene)

IG_C_gene = p_list_biotype[which(p_list_biotypes_EnsDb$GENEBIOTYPE == "IG_C_gene"), 1]
length(IG_C_gene)

IG_V_gene = p_list_biotype[which(p_list_biotypes_EnsDb$GENEBIOTYPE == "IG_V_gene"), 1]
length(IG_V_gene)

TR_V_gene = p_list_biotype[which(p_list_biotypes_EnsDb$GENEBIOTYPE == "TR_V_gene"), 1]
length(TR_V_gene)

IG_C_pseudogene = p_list_biotype[which(p_list_biotypes_EnsDb$GENEBIOTYPE == "IG_C_pseudogene"), 1]
length(IG_C_pseudogene)

TR_C_gene = p_list_biotype[which(p_list_biotypes_EnsDb$GENEBIOTYPE == "TR_C_gene"), 1]
length(TR_C_gene)

transcribed_unitary_pseudogene = p_list_biotype[which(p_list_biotypes_EnsDb$GENEBIOTYPE == "transcribed_unitary_pseudogene"), 1]
length(transcribed_unitary_pseudogene)

transcribed_unprocessed_pseudogene = p_list_biotype[which(p_list_biotypes_EnsDb$GENEBIOTYPE == "transcribed_unprocessed_pseudogene"), 1]
length(transcribed_unprocessed_pseudogene)

transcribed_processed_pseudogene = p_list_biotype[which(p_list_biotypes_EnsDb$GENEBIOTYPE == "transcribed_processed_pseudogene"), 1]
length(transcribed_processed_pseudogene)
```

Let's combine and store them in the variable *non_coding_pathway_genes*

```{r}
non_coding_pathway_genes_ens = c(miRNA, polymorphic_pseudogene, Mt_rRNA, lncRNA, processed_pseudogene, unprocessed_pseudogene, IG_C_gene, IG_V_gene, TR_V_gene, IG_C_pseudogene, TR_C_gene, transcribed_unitary_pseudogene, transcribed_unprocessed_pseudogene, transcribed_processed_pseudogene)
```

Before disregarding any of these non coding genes, checking whether any of these genes can be found in our own dataset should be done

```{r}
matches = match(non_coding_pathway_genes_ens, genes_ensembl)
length(matches)


matched_non_coding_pathway_genes = non_coding_pathway_genes_ens[na.omit(matches)]
length(matched_non_coding_pathway_genes) # we end up with 53 matched genes
```

In order to perform a PCA later on, reducing tcga_exp_cleaned by only looking at the matched non coding pathway genes, the protein coding pathway genes, and the genes of our expressed genes that couldn't be defined by a biotype might be helpful

```{r}
tcga_exp_cleaned_reduced = tcga_exp_cleaned[c(unmatched_genes, matched_non_coding_pathway_genes, protein_coding),]
dim(tcga_exp_cleaned_reduced) # we end up with 8766 genes
```

checking for duplicated genes (should be all unique though)

```{r}
duplicates = duplicated(rownames(tcga_exp_cleaned_reduced))
table(duplicates)
```

```{r}
#saveRDS(tcga_exp_cleaned_reduced, file = "tcga_exp_x_total_pathways.rds")
```


***

```{r}
TCGA_biotypes
pathways_biotypes
```

